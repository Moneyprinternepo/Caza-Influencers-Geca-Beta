<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Caza Influencers</title>
  <!--  üé®  Estilos  -->
  <style>
    :root{--primary:#ef4444;--primary-dark:#7f1d1d;--bg-dark:#111;--bg-card:#1f1f1f;--bg-input:#2d2d2d;--text:#fff;--text-secondary:#aaa;--border:#444}
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:var(--bg-dark);color:var(--text);padding:20px}
    .container{max-width:1200px;margin:0 auto}
    header{text-align:center;margin-bottom:30px}
    h1{font-size:3rem;text-transform:uppercase;letter-spacing:3px;background:linear-gradient(to right,var(--primary),var(--primary-dark));-webkit-background-clip:text;color:transparent;margin-bottom:20px}
    .logos{display:flex;justify-content:space-between;align-items:center}
    .logos img{height:60px}
    .tabs{display:flex;justify-content:center;gap:10px;margin-bottom:20px}
    .tab{padding:10px 20px;border-radius:5px;background:var(--bg-card);border:none;color:var(--text);cursor:pointer;transition:background .3s}
    .tab.active{background:var(--primary)}
    .filter-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;padding:15px;border-radius:10px;background:var(--bg-card);border:1px solid var(--primary);margin-bottom:20px}
    select,input{padding:8px;border-radius:5px;background:var(--bg-input);border:1px solid var(--border);color:var(--text)}
    .search-btn{background:linear-gradient(to right,var(--primary),var(--primary-dark));color:#fff;border:none;padding:8px 12px;border-radius:5px;cursor:pointer;font-weight:bold}
    .results-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
    .result-card{background:var(--bg-card);border:1px solid var(--primary);border-radius:5px;padding:15px;cursor:pointer;transition:background .3s}
    .result-card:hover{background:#2a2a2a}
    .result-card h3{font-size:1.2rem;margin-bottom:5px}
    .result-card p{font-size:.9rem;margin-bottom:3px}
    .text-secondary{color:var(--text-secondary)}
    .text-impact{color:#22c55e;font-weight:bold}
    .detail-view{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:20px}
    .detail-header{display:flex;align-items:center;gap:20px;margin-bottom:20px}
    .avatar{width:120px;height:120px;border-radius:50%;border:2px solid var(--border);object-fit:cover}
    .back-btn{color:var(--primary);background:none;border:none;cursor:pointer;text-decoration:underline;margin-top:10px}
    .tags{display:flex;flex-wrap:wrap;gap:5px;margin:10px 0}
    .tag{background:var(--bg-input);padding:3px 10px;border-radius:999px;font-size:.8rem}
    .charts-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}
    .chart-container{background:#2a2a2a;border-radius:10px;padding:15px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .chart-title{font-size:.9rem;margin-bottom:10px;font-weight:bold}
    .campaign-view{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:20px}
    .upload-area{border:2px dashed var(--border);padding:30px;border-radius:10px;text-align:center;margin-bottom:20px;cursor:pointer}
    .upload-area:hover{border-color:var(--primary)}
    .hidden{display:none}
    .loader{border:5px solid var(--bg-input);border-top:5px solid var(--primary);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:20px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    @media(max-width:768px){.filter-bar{grid-template-columns:1fr}.results-grid{grid-template-columns:1fr}.detail-header{flex-direction:column;text-align:center}.charts-row{grid-template-columns:1fr}}
  </style>

  <!--  üì¶ Dependencias  -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>
</head>
<body>
  <div class="container" id="mainContent" style="display:none">
    <header>
      <h1>Caza Influencers</h1>
      <div class="logos">
        <img src="https://images.mediapro.es/generic/companies/logo_geca.png" alt="Logo Marca" />
        <img src="https://www.cinesfilmax.com/assets/cinesfilmax-logo.svg"/>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="explorar">Explorar</button>
      <button class="tab" data-tab="campanas">Tus campa√±as</button>
    </div>

    <!--  VISTA EXPLORAR  -->
    <div id="explore-view">
      <div class="filter-bar">
        <select id="platform-filter"><option value="Todos">Todas las plataformas</option><option value="YouTube">YouTube</option><option value="Instagram">Instagram</option><option value="TikTok">TikTok</option><option value="Reddit">Reddit</option></select>
        <select id="followers-filter"><option value="Todos">Todos los seguidores</option><option value="<100K">Menos de 100K</option><option value="100K-500K">Entre 100K y 500K</option><option value=">500K">M√°s de 500K</option></select>
        <select id="tag1-filter"><option value="Todos">Todos los nichos</option></select>
        <select id="tag2-filter"><option value="Todos">Todos los nichos (2)</option></select>
        <input type="text" id="search-input" placeholder="Buscar..." />
        <button class="search-btn" id="search-btn" disabled>üîç Buscar</button>
      </div>
      <div id="results-container" class="results-grid hidden"></div>
      <div id="detail-container" class="detail-view hidden"></div>
      <div id="loader" class="loader"></div>
    </div>

    <!--  VISTA CAMPA√ëAS  -->
    <div id="campaign-view" class="campaign-view hidden">
      <h2 style="color:var(--primary);margin-bottom:15px">Tus campa√±as</h2>
      <div id="campaign-data" class="hidden">
        <h3 id="campaign-name">Nombre de la campa√±a</h3>
        <p class="text-secondary">Marca: <span id="campaign-brand"></span> ‚Ä¢ <span id="campaign-date"></span></p>
        <p>üéØ Influencers: <span id="campaign-influencers"></span></p>
        <p>üë• Alcance estimado: <span id="campaign-reach"></span></p>
        <p>üìà ROI estimado: <span id="campaign-roi" class="text-impact"></span></p>
        <div class="chart-container" style="margin-top:20px"><div class="chart-title">Rendimiento mensual</div><canvas id="campaign-chart"></canvas></div>
      </div>
    </div>
  </div>

  <script>
    /* -------------------------------------------------------------
       ESTRUCTURA GLOBAL
    -------------------------------------------------------------*/
    let currentData = []; // se llena desde data/influencers.csv
    let filteredData = [];
    let selectedInfluencer = null;
    let campaignChart = null;
    let csvLoaded = false;

    const sampleCampaign = {
      id:1,name:"Dinosaurios de la Patagonia",brand:"Caixa",date:"2025-03-10",influencers:[1,2],roi:2.3,
      stats:[
        {month:'Ene',engagement:20000,views:30000},{month:'Feb',engagement:10000,views:12000},{month:'Mar',engagement:14800,views:16000},{month:'Abr',engagement:11000,views:8000},{month:'May',engagement:15000,views:17000},{month:'Jun',engagement:10000,views:18000},{month:'Jul',engagement:4000,views:9000},{month:'Ago',engagement:2000,views:6000},{month:'Sep',engagement:1000,views:3000},{month:'Oct',engagement:1500,views:4000},{month:'Nov',engagement:2200,views:5000},{month:'Dic',engagement:1800,views:4500}
      ]};

    /* -------------------- DOM ELEMENTS --------------------*/
    const tabs=document.querySelectorAll('.tab');
    const exploreView=document.getElementById('explore-view');
    const campaignView=document.getElementById('campaign-view');
    const resultsContainer=document.getElementById('results-container');
    const detailContainer=document.getElementById('detail-container');
    const loader=document.getElementById('loader');
    const platformFilter=document.getElementById('platform-filter');
    const followersFilter=document.getElementById('followers-filter');
    const tag1Filter=document.getElementById('tag1-filter');
    const tag2Filter=document.getElementById('tag2-filter');
    const searchInput=document.getElementById('search-input');
    const searchBtn=document.getElementById('search-btn');

    /* -------------------------------------------------------------
       UTILIDADES
    -------------------------------------------------------------*/
    const calculateImpact=i=>((i.likesAvg/i.followers + i.commentsAvg/i.followers)*100*1.2).toFixed(2);

    function populateTagFilters(){
      // limpia opciones previas excepto "Todos"
      tag1Filter.length=1;tag2Filter.length=1;
      const tags=[...new Set(currentData.flatMap(it=>Array.isArray(it.niche)?it.niche:it.niche.split('|').map(s=>s.trim())))].sort();
      tags.forEach(tag=>{
        const o1=new Option(tag,tag);const o2=new Option(tag,tag);
        tag1Filter.appendChild(o1);tag2Filter.appendChild(o2);
      });
    }

    function filterData(){
      if(!csvLoaded) return; // seguridad
      loader.classList.remove('hidden');resultsContainer.classList.add('hidden');
      setTimeout(()=>{
        const platform=platformFilter.value,followers=followersFilter.value,tag1=tag1Filter.value,tag2=tag2Filter.value,term=searchInput.value.toLowerCase();
        filteredData=currentData.filter(it=>{
          if(platform!=='Todos' && it.platform!==platform) return false;
          if(followers==='<100K' && it.followers>=100000) return false;
          if(followers==='100K-500K' && (it.followers<100000||it.followers>500000)) return false;
          if(followers==='>500K' && it.followers<=500000) return false;
          if(tag1!=='Todos' && !it.niche.includes(tag1)) return false;
          if(tag2!=='Todos' && !it.niche.includes(tag2)) return false;
          if(term && !it.name.toLowerCase().includes(term) && !it.niche.some(n=>n.toLowerCase().includes(term))) return false;
          return true;
        });
        displayResults();
        loader.classList.add('hidden');resultsContainer.classList.remove('hidden');
      },300);
    }

    function displayResults(){
      resultsContainer.innerHTML='';
      if(filteredData.length===0){resultsContainer.innerHTML='<p>No se encontraron resultados.</p>';return;}
      filteredData.forEach(item=>{
        const impact=calculateImpact(item);item.impact=impact;
        const card=document.createElement('div');card.className='result-card';
        card.innerHTML=`<h3>${item.name}</h3><p class="text-secondary">${item.platform}</p><p>üë• Seguidores: ${item.followers.toLocaleString()}</p><p>‚ù§Ô∏è Likes: ${item.likesAvg.toLocaleString()}</p><p>üí¨ Comentarios: ${item.commentsAvg.toLocaleString()}</p><p class="text-impact">üìä Impacto: ${impact}%</p>`;
        card.addEventListener('click',()=>{selectedInfluencer=item;displayDetail(item)});
        resultsContainer.appendChild(card);
      });
    }

    /* ---------------- DETALLE ----------------*/
    function displayDetail(inf){
      resultsContainer.classList.add('hidden');detailContainer.classList.remove('hidden');
      const demoPlatforms=[{name:'Instagram',value:40},{name:'YouTube',value:30},{name:'TikTok',value:20},{name:'Facebook',value:10}];
      const demoAges=[{range:'<12',value:3},{range:'13-17',value:12},{range:'18-24',value:25},{range:'25-34',value:30},{range:'35-44',value:15},{range:'45-54',value:10},{range:'55-64',value:3},{range:'>65',value:2}];
      const demoGender=[{name:'Hombres',value:55},{name:'Mujeres',value:45}];

      detailContainer.innerHTML=`<div class="detail-header"><img src="https://placehold.co/120x120?text=${encodeURIComponent(inf.name.charAt(0))}" class="avatar" alt="${inf.name}"><div><h2>${inf.name}</h2><p class="text-secondary">${inf.platform} ‚Ä¢ Seguidores: ${inf.followers.toLocaleString()}</p><p>‚ù§Ô∏è Likes: ${inf.likesAvg.toLocaleString()} ‚Ä¢ üí¨ Comentarios: ${inf.commentsAvg.toLocaleString()}</p><p class="text-impact">üìä Impacto: ${inf.impact}%</p></div></div><h4 style="margin-top:15px;font-size:.9rem">Nichos</h4><div class="tags">${inf.niche.map(t=>`<span class="tag">${t}</span>`).join('')}</div><button class="back-btn" id="back-btn">‚Üê Volver</button><div class="charts-row"><div class="chart-container"><div class="chart-title">Distribuci√≥n por plataforma</div><canvas id="platform-chart"></canvas></div><div class="chart-container"><div class="chart-title">Distribuci√≥n por edad</div><canvas id="age-chart"></canvas></div></div><div class="chart-container" style="margin-top:20px"><div class="chart-title">Distribuci√≥n por g√©nero</div><canvas id="gender-chart"></canvas></div>`;
      document.getElementById('back-btn').onclick=()=>{detailContainer.classList.add('hidden');resultsContainer.classList.remove('hidden');};
      createBarChart('platform-chart',demoPlatforms.map(d=>d.name),demoPlatforms.map(d=>d.value),'rgba(239,68,68,0.8)','rgba(239,68,68,1)');
      createBarChart('age-chart',demoAges.map(d=>d.range),demoAges.map(d=>d.value),'rgba(59,130,246,0.8)','rgba(59,130,246,1)');
      createPieChart('gender-chart',demoGender.map(d=>d.name),demoGender.map(d=>d.value),['rgba(239,68,68,0.8)','rgba(59,130,246,0.8)'],['rgba(239,68,68,1)','rgba(59,130,246,1)']);
    }

    function createBarChart(canvasId,labels,data,bg,border){new Chart(document.getElementById(canvasId),{type:'bar',data:{labels,datasets:[{data,label:'Distribuci√≥n',backgroundColor:bg,borderColor:border,borderWidth:1}]},options:{responsive:true,scales:{y:{beginAtZero:true,ticks:{color:'#aaa'},grid:{color:'#444'}},x:{ticks:{color:'#aaa'},grid:{color:'#444'}}},plugins:{legend:{display:false}}}});}
    function createPieChart(canvasId,labels,data,bg,border){new Chart(document.getElementById(canvasId),{type:'pie',data:{labels,datasets:[{data,backgroundColor:bg,borderColor:border,borderWidth:1}]},options:{plugins:{legend:{position:'bottom',labels:{color:'#aaa'}},tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw}%`}}}}});}

    /* ---------------- CAMPA√ëAS ----------------*/
    function displayCampaignData(){
      if(!csvLoaded){alert('Datos de influencers a√∫n carg√°ndose‚Ä¶');return;}
      document.getElementById('campaign-name').textContent=sampleCampaign.name;
      document.getElementById('campaign-brand').textContent=sampleCampaign.brand;
      document.getElementById('campaign-date').textContent=sampleCampaign.date;
      const influencerNames=sampleCampaign.influencers.map(id=>currentData.find(i=>i.id==id)?.name||'Desconocido').join(', ');
      document.getElementById('campaign-influencers').textContent=influencerNames;
      const reach=sampleCampaign.influencers.reduce((sum,id)=>sum+(currentData.find(i=>i.id==id)?.followers||0),0);
      document.getElementById('campaign-reach').textContent=reach.toLocaleString();
      document.getElementById('campaign-roi').textContent=sampleCampaign.roi+'x';
      const ctx=document.getElementById('campaign-chart').getContext('2d');
      if(campaignChart) campaignChart.destroy();
      campaignChart=new Chart(ctx,{type:'line',data:{labels:sampleCampaign.stats.map(s=>s.month),datasets:[{label:'Engagement',data:sampleCampaign.stats.map(s=>s.engagement),borderColor:'rgba(239,68,68,1)',backgroundColor:'rgba(239,68,68,0.1)',tension:0.3},{label:'Visualizaciones',data:sampleCampaign.stats.map(s=>s.views),borderColor:'rgba(34,197,94,1)',backgroundColor:'rgba(34,197,94,0.1)',tension:0.3}]},options:{responsive:true,scales:{y:{beginAtZero:true,ticks:{color:'#aaa'},grid:{color:'#444'}},x:{ticks:{color:'#aaa'},grid:{color:'#444'}}},plugins:{legend:{position:'bottom',labels:{color:'#aaa'}}}}});
      document.getElementById('campaign-data').classList.remove('hidden');
    }

    /* ---------------- CSV LOAD ----------------*/
    function loadInfluencersCsv(){
      return new Promise((resolve,reject)=>{
        Papa.parse('data/influencers.csv',{download:true,header:true,dynamicTyping:true,complete:({data})=>{
          currentData=data.filter(r=>r.name);
          csvLoaded=true;filteredData=[...currentData];
          populateTagFilters();searchBtn.removeAttribute('disabled');loader.classList.add('hidden');resultsContainer.classList.remove('hidden');
          filterData();resolve();},error:err=>reject(err)});
      });
    }

    /* ---------------- TABS ----------------*/
    function handleTabClick(e){tabs.forEach(t=>t.classList.remove('active'));e.target.classList.add('active');if(e.target.dataset.tab==='explorar'){campaignView.classList.add('hidden');exploreView.classList.remove('hidden');}else{exploreView.classList.add('hidden');campaignView.classList.remove('hidden');displayCampaignData();}}

    /* ---------------- TESTS ----------------*/
    function runTests(){console.assert(typeof Chart!=='undefined','Chart.js no cargado');console.assert(csvLoaded,'CSV influencers no cargado');console.assert(currentData.length>0,'CSV vac√≠o');const dup=[...new Set(currentData.map(i=>i.id))];console.assert(dup.length                                       ===currentData.length,'IDs duplicados en CSV');console.log('%c‚úîÔ∏é Test b√°sicos OK','color:lime');}

    /* ---------------- INIT ----------------*/
    document.addEventListener('DOMContentLoaded',()=>{
      searchBtn.onclick=filterData;tabs.forEach(t=>t.addEventListener('click',handleTabClick));
      loadInfluencersCsv().then(runTests).catch(e=>{loader.classList.add('hidden');alert('Error cargando influencers.csv: '+e.message);});
    });
  </script>
  <!-- Login Modal -->
<div id="loginModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000a;display:flex;align-items:center;justify-content:center;z-index:9999;">
  <div style="background:#1f1f1f;padding:30px;border-radius:10px;border:1px solid #ef4444;width:300px;text-align:center;color:white">
    <h2 style="margin-bottom:15px">Iniciar sesi√≥n</h2>
    <input type="text" id="loginUser" placeholder="Usuario" style="width:100%;margin-bottom:10px;padding:8px;background:#2d2d2d;border:1px solid #444;color:white;border-radius:5px"><br>
    <input type="password" id="loginPass" placeholder="Contrase√±a" style="width:100%;margin-bottom:10px;padding:8px;background:#2d2d2d;border:1px solid #444;color:white;border-radius:5px"><br>
    <button onclick="handleLogin()" style="width:100%;padding:8px;background:#ef4444;border:none;border-radius:5px;font-weight:bold;color:white">Entrar</button>
    <p id="loginError" style="color:#f87171;margin-top:10px;display:none">Usuario o contrase√±a incorrectos</p>
  </div>
</div>
<script>
  function handleLogin() {
    const username = document.getElementById('loginUser').value;
    const password = document.getElementById('loginPass').value;
    const errorMsg = document.getElementById('loginError');

    // Simulaci√≥n de credenciales v√°lidas
    const validUsers = [
      { username: 'admin', password: 'admin123' },
      { username: 'Filmax', password: 'PolCrack' },
      { username: 'Geca', password: 'Geca123' }
    ];

    const valid = validUsers.some(u => u.username === username && u.password === password);

    if (valid) {
      localStorage.setItem('isLoggedIn', 'true');
      localStorage.setItem('username', username);
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    } else {
      errorMsg.style.display = 'block';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    if (isLoggedIn) {
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }
  });
</script>
</body>
</html>
